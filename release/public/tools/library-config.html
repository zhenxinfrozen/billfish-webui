<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>Billfish èµ„æ–™åº“é…ç½®ç®¡ç†</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f7f7f7; margin: 0; padding: 0; }
        .container { max-width: 800px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 32px; }
        h1 { font-size: 2rem; margin-bottom: 1rem; }
        .lib-list { margin-bottom: 2rem; }
        .lib-item { border-bottom: 1px solid #eee; padding: 12px 0; display: flex; align-items: center; justify-content: space-between; }
        .lib-info { flex: 1; }
        .lib-path { color: #888; font-size: 0.95em; }
        .lib-stats { color: #666; font-size: 0.95em; margin-top: 2px; }
        .lib-actions button { margin-left: 8px; }
        .active { color: #2196f3; font-weight: bold; }
        .add-form, .nas-scan { margin-bottom: 2rem; }
        label { display: block; margin-bottom: 4px; font-weight: 500; }
        input, select { width: 100%; padding: 8px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 4px; }
        button { background: #2196f3; color: #fff; border: none; border-radius: 4px; padding: 8px 18px; cursor: pointer; font-size: 1em; }
        button:disabled { background: #aaa; }
        .msg { margin: 12px 0; color: #d32f2f; }
        .success { color: #388e3c; }
        .tips { background: #e3f2fd; color: #1976d2; padding: 10px 16px; border-radius: 4px; margin-bottom: 18px; }
        @media (max-width: 600px) { .container { padding: 10px; } }
    </style>
</head>
<body>
<div class="container">
    <h1>Billfish èµ„æ–™åº“é…ç½®ç®¡ç†</h1>
    <div class="tips">
        <b>æ”¯æŒå››ç§é…ç½®æ–¹å¼ï¼š</b><br>
        1. <b>é¡¹ç›®å†…æœ¬åœ°</b>ï¼šå¦‚ <code>publish/assets/viedeos/rzxme-billfish</code>ï¼ˆç›¸å¯¹äºå½“å‰é¡¹ç›®ï¼‰<br>
        2. <b>ç”µè„‘æœ¬åœ°</b>ï¼šå¦‚ <code>D:/MyBillfish/Library</code>ï¼ˆç”µè„‘ä¸Šçš„ç»å¯¹è·¯å¾„ï¼‰<br>
        3. <b>NAS/ç½‘ç»œ</b>ï¼šå¦‚ <code>S:/OneDrive-irm/Bill-Eagle/Bill-Material</code>ï¼ˆæŒ‚è½½çš„ç½‘ç»œé©±åŠ¨å™¨ï¼‰<br>
        4. <b>VPSè¿œç¨‹</b>ï¼šå¦‚ <code>/mnt/nas/billfish/Bill-Material</code>ï¼ˆLinux/Unixæ ¼å¼ï¼‰<br>
        <span style="color:#888;">åˆ‡æ¢åè‡ªåŠ¨ä¿®æ”¹ config.phpï¼Œæ— éœ€æ‰‹åŠ¨ç¼–è¾‘ã€‚</span>
    </div>

    <div class="lib-list" id="lib-list"></div>

    <form class="add-form" id="add-form">
        <h2>æ·»åŠ æ–°èµ„æ–™åº“</h2>
        <label>åç§°</label>
        <input type="text" name="name" required placeholder="å¦‚ï¼šä¸»ç´ æåº“">
        <label>ç±»å‹</label>
        <select name="type">
            <option value="project">é¡¹ç›®å†…æœ¬åœ°</option>
            <option value="computer">ç”µè„‘æœ¬åœ°</option>
            <option value="nas">NAS/ç½‘ç»œ</option>
            <option value="vps">VPSè¿œç¨‹</option>
        </select>
        <label>è·¯å¾„</label>
        <input type="text" name="path" id="path-input" required placeholder="é¡¹ç›®å†…: publish/assets/viedeos/rzxme-billfish">
        <div style="margin-bottom: 12px;">
            <small id="path-hint" style="color: #666;">
                ğŸ’¡ <b>é¡¹ç›®å†…è·¯å¾„ï¼š</b>ç›¸å¯¹äºå½“å‰é¡¹ç›®çš„è·¯å¾„ï¼Œå¦‚ <code>publish/assets/viedeos/rzxme-billfish</code>
            </small>
            <button type="button" id="normalize-path-btn" style="margin-left: 8px; padding: 4px 8px; font-size: 0.85em; background: #f0f0f0; color: #333;">
                ğŸ”„ è½¬æ¢è·¯å¾„æ ¼å¼
            </button>
        </div>
        <label>æè¿°</label>
        <input type="text" name="description" placeholder="å¯é€‰ï¼šå¤‡æ³¨è¯´æ˜">
        <button type="submit">æ·»åŠ èµ„æ–™åº“</button>
        <div class="msg" id="add-msg"></div>
    </form>

    <form class="nas-scan" id="nas-scan-form">
        <h2>æ‰«æNASç›®å½•ä¸‹æ‰€æœ‰Billfishåº“</h2>
        <label>NASæ ¹è·¯å¾„</label>
        <input type="text" name="nas_path" id="nas-path-input" placeholder="å¦‚ï¼šS:/OneDrive-irm/Bill-Eagle">
        <div style="margin-bottom: 12px;">
            <small style="color: #666;">
                ğŸ’¡ å¯ç›´æ¥ç²˜è´´Windowsè·¯å¾„ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è½¬æ¢æ ¼å¼
            </small>
            <button type="button" id="normalize-nas-path-btn" style="margin-left: 8px; padding: 4px 8px; font-size: 0.85em; background: #f0f0f0; color: #333;">
                ğŸ”„ è½¬æ¢è·¯å¾„æ ¼å¼
            </button>
        </div>
        <button type="submit">æ‰«æå¹¶æ‰¹é‡æ·»åŠ </button>
        <div class="msg" id="nas-msg"></div>
    </form>
</div>
<script>
function fetchLibraries() {
    fetch('../api/library-config.php?action=list').then(r=>r.json()).then(data => {
        const list = document.getElementById('lib-list');
        if (!data.success) { list.innerHTML = '<div class="msg">åŠ è½½å¤±è´¥</div>'; return; }
        let html = '<h2>å·²é…ç½®èµ„æ–™åº“</h2>';
        if (data.libraries.length === 0) {
            html += '<div class="msg">æš‚æ— èµ„æ–™åº“</div>';
        } else {
            data.libraries.forEach(lib => {
                html += `<div class="lib-item${lib.active ? ' active' : ''}">
                    <div class="lib-info">
                        <span class="${lib.active ? 'active' : ''}">${lib.name}${lib.active ? 'ï¼ˆå½“å‰ï¼‰' : ''}</span><br>
                        <span class="lib-path">${lib.path}</span>
                        <div class="lib-stats">${lib.stats ? `æ–‡ä»¶æ•°: ${lib.stats.files}ï¼Œå¤§å°: ${lib.stats.size_gb}GB` : ''}</div>
                        <div style="color:#888;font-size:0.95em;">${lib.description||''}</div>
                    </div>
                    <div class="lib-actions">
                        ${!lib.active ? `<button onclick="switchLib('${lib.id}')">åˆ‡æ¢</button>` : ''}
                        ${!lib.active ? `<button onclick="deleteLib('${lib.id}')" style='background:#e53935;'>åˆ é™¤</button>` : ''}
                    </div>
                </div>`;
            });
        }
        list.innerHTML = html;
    });
}

function switchLib(id) {
    if (!confirm('ç¡®å®šè¦åˆ‡æ¢åˆ°è¯¥èµ„æ–™åº“å—ï¼Ÿ')) return;
    fetch('../api/library-config.php?action=switch', {
        method: 'POST',
        body: JSON.stringify({id})
    }).then(r=>r.json()).then(data => {
        if (data.success) {
            alert('åˆ‡æ¢æˆåŠŸï¼');
            fetchLibraries();
        } else {
            alert('åˆ‡æ¢å¤±è´¥ï¼š' + (data.error||'æœªçŸ¥é”™è¯¯'));
        }
    });
}

function deleteLib(id) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥èµ„æ–™åº“å—ï¼Ÿ')) return;
    fetch('../api/library-config.php?action=delete', {
        method: 'POST',
        body: JSON.stringify({id})
    }).then(r=>r.json()).then(data => {
        if (data.success) {
            fetchLibraries();
        } else {
            alert('åˆ é™¤å¤±è´¥ï¼š' + (data.error||'æœªçŸ¥é”™è¯¯'));
        }
    });
}

document.getElementById('add-form').onsubmit = function(e) {
    e.preventDefault();
    const form = e.target;
    const msg = document.getElementById('add-msg');
    msg.textContent = '';
    const data = {
        name: form.name.value.trim(),
        type: form.type.value,
        path: form.path.value.trim(),
        description: form.description.value.trim()
    };
    fetch('../api/library-config.php?action=add', {
        method: 'POST',
        body: JSON.stringify(data)
    }).then(r=>r.json()).then(data => {
        if (data.success) {
            msg.textContent = 'æ·»åŠ æˆåŠŸï¼';
            msg.className = 'msg success';
            fetchLibraries();
            form.reset();
        } else {
            msg.textContent = (data.errors ? data.errors.join('ï¼›') : (data.error||'æ·»åŠ å¤±è´¥'));
            msg.className = 'msg';
        }
    });
};

document.getElementById('nas-scan-form').onsubmit = function(e) {
    e.preventDefault();
    const form = e.target;
    const msg = document.getElementById('nas-msg');
    msg.textContent = '';
    const nas_path = form.nas_path.value.trim();
    if (!nas_path) { msg.textContent = 'è¯·è¾“å…¥NASæ ¹è·¯å¾„'; return; }
    msg.textContent = 'æ­£åœ¨æ‰«æ...';
    fetch('../api/library-config.php?action=scan_nas', {
        method: 'POST',
        body: JSON.stringify({path: nas_path})
    }).then(r=>r.json()).then(data => {
        if (data.success) {
            if (data.libraries.length === 0) {
                msg.textContent = 'æœªå‘ç°ä»»ä½•Billfishèµ„æ–™åº“';
            } else {
                msg.textContent = 'å‘ç°' + data.libraries.length + 'ä¸ªèµ„æ–™åº“ï¼Œæ­£åœ¨æ‰¹é‡æ·»åŠ ...';
                let added = 0;
                data.libraries.forEach(lib => {
                    fetch('../api/library-config.php?action=add', {
                        method: 'POST',
                        body: JSON.stringify({
                            name: lib.name,
                            type: 'nas',
                            path: lib.path,
                            description: 'NASæ‰¹é‡å¯¼å…¥',
                        })
                    }).then(r=>r.json()).then(res => {
                        added++;
                        if (added === data.libraries.length) {
                            msg.textContent = 'æ‰¹é‡æ·»åŠ å®Œæˆï¼';
                            fetchLibraries();
                        }
                    });
                });
            }
        } else {
            msg.textContent = data.error || 'æ‰«æå¤±è´¥';
        }
    });
};

// è·¯å¾„æ ¼å¼è½¬æ¢åŠŸèƒ½
function normalizePath(path) {
    if (!path) return path;
    
    // å»é™¤é¦–å°¾ç©ºç™½å­—ç¬¦
    path = path.trim();
    
    // å°†åæ–œæ è½¬æ¢ä¸ºæ­£æ–œæ 
    path = path.replace(/\\/g, '/');
    
    // å¤„ç†å¤šä¸ªè¿ç»­æ–œæ 
    path = path.replace(/\/+/g, '/');
    
    // ç§»é™¤æœ«å°¾çš„æ–œæ ï¼ˆé™¤éæ˜¯æ ¹ç›®å½•ï¼‰
    path = path.replace(/\/$/, '');
    
    return path;
}

// è·¯å¾„è½¬æ¢æŒ‰é’®äº‹ä»¶
document.getElementById('normalize-path-btn').onclick = function() {
    const pathInput = document.getElementById('path-input');
    const originalPath = pathInput.value;
    const normalizedPath = normalizePath(originalPath);
    
    if (originalPath !== normalizedPath) {
        pathInput.value = normalizedPath;
        
        // æ˜¾ç¤ºè½¬æ¢ç»“æœ
        const msg = document.getElementById('add-msg');
        msg.textContent = 'è·¯å¾„å·²è½¬æ¢: ' + originalPath + ' â†’ ' + normalizedPath;
        msg.className = 'msg success';
        
        // 3ç§’åæ¸…é™¤æ¶ˆæ¯
        setTimeout(() => {
            if (msg.textContent.includes('è·¯å¾„å·²è½¬æ¢')) {
                msg.textContent = '';
            }
        }, 3000);
    } else {
        const msg = document.getElementById('add-msg');
        msg.textContent = 'è·¯å¾„æ ¼å¼å·²æ­£ç¡®ï¼Œæ— éœ€è½¬æ¢';
        msg.className = 'msg success';
        
        setTimeout(() => {
            if (msg.textContent.includes('æ— éœ€è½¬æ¢')) {
                msg.textContent = '';
            }
        }, 2000);
    }
};

// è¾“å…¥æ¡†å¤±ç„¦æ—¶è‡ªåŠ¨è½¬æ¢è·¯å¾„
document.getElementById('path-input').onblur = function() {
    const originalPath = this.value;
    const normalizedPath = normalizePath(originalPath);
    
    if (originalPath !== normalizedPath) {
        this.value = normalizedPath;
    }
};

// NASè·¯å¾„è½¬æ¢æŒ‰é’®äº‹ä»¶
document.getElementById('normalize-nas-path-btn').onclick = function() {
    const pathInput = document.getElementById('nas-path-input');
    const originalPath = pathInput.value;
    const normalizedPath = normalizePath(originalPath);
    
    if (originalPath !== normalizedPath) {
        pathInput.value = normalizedPath;
        
        // æ˜¾ç¤ºè½¬æ¢ç»“æœ
        const msg = document.getElementById('nas-msg');
        msg.textContent = 'è·¯å¾„å·²è½¬æ¢: ' + originalPath + ' â†’ ' + normalizedPath;
        msg.className = 'msg success';
        
        // 3ç§’åæ¸…é™¤æ¶ˆæ¯
        setTimeout(() => {
            if (msg.textContent.includes('è·¯å¾„å·²è½¬æ¢')) {
                msg.textContent = '';
            }
        }, 3000);
    } else {
        const msg = document.getElementById('nas-msg');
        msg.textContent = 'è·¯å¾„æ ¼å¼å·²æ­£ç¡®ï¼Œæ— éœ€è½¬æ¢';
        msg.className = 'msg success';
        
        setTimeout(() => {
            if (msg.textContent.includes('æ— éœ€è½¬æ¢')) {
                msg.textContent = '';
            }
        }, 2000);
    }
};

// NASè¾“å…¥æ¡†å¤±ç„¦æ—¶è‡ªåŠ¨è½¬æ¢è·¯å¾„
document.getElementById('nas-path-input').onblur = function() {
    const originalPath = this.value;
    const normalizedPath = normalizePath(originalPath);
    
    if (originalPath !== normalizedPath) {
        this.value = normalizedPath;
    }
};

// ç±»å‹é€‰æ‹©å˜åŒ–æ—¶æ›´æ–°æç¤ºå’Œå ä½ç¬¦
document.querySelector('select[name="type"]').onchange = function() {
    const pathInput = document.getElementById('path-input');
    const pathHint = document.getElementById('path-hint');
    const normalizeBtn = document.getElementById('normalize-path-btn');
    
    switch(this.value) {
        case 'project':
            pathInput.placeholder = 'å¦‚ï¼špublish/assets/viedeos/rzxme-billfish';
            pathHint.innerHTML = 'ğŸ’¡ <b>é¡¹ç›®å†…è·¯å¾„ï¼š</b>ç›¸å¯¹äºå½“å‰é¡¹ç›®çš„è·¯å¾„ï¼Œå¦‚ <code>publish/assets/viedeos/rzxme-billfish</code>';
            normalizeBtn.style.display = 'none';
            break;
        case 'computer':
            pathInput.placeholder = 'å¦‚ï¼šD:/MyBillfish/Library';
            pathHint.innerHTML = 'ğŸ’¡ <b>ç”µè„‘æœ¬åœ°ï¼š</b>å¯ç›´æ¥ç²˜è´´èµ„æºç®¡ç†å™¨è·¯å¾„ï¼ˆå¦‚ <code>D:\\folder\\path</code>ï¼‰ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è½¬æ¢';
            normalizeBtn.style.display = 'inline-block';
            break;
        case 'nas':
            pathInput.placeholder = 'å¦‚ï¼šS:/OneDrive-irm/Bill-Eagle/Bill-Material';
            pathHint.innerHTML = 'ğŸ’¡ <b>NAS/ç½‘ç»œï¼š</b>æŒ‚è½½çš„ç½‘ç»œé©±åŠ¨å™¨è·¯å¾„ï¼Œæ”¯æŒWindowsè·¯å¾„æ ¼å¼è‡ªåŠ¨è½¬æ¢';
            normalizeBtn.style.display = 'inline-block';
            break;
        case 'vps':
            pathInput.placeholder = 'å¦‚ï¼š/mnt/nas/billfish/Bill-Material';
            pathHint.innerHTML = 'ğŸ’¡ <b>VPSè¿œç¨‹ï¼š</b>Linux/Unixæ ¼å¼è·¯å¾„ï¼Œå¦‚ <code>/mnt/nas/billfish/Bill-Material</code>';
            normalizeBtn.style.display = 'none';
            break;
    }
};

fetchLibraries();
</script>
</body>
</html>
