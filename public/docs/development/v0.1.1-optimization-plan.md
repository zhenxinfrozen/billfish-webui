# v0.1.1 优化计划

## 📅 版本信息
- **版本**: v0.1.1
- **日期**: 2025-10-15
- **基于**: v0.1.0

## 🎯 优化目标

### 1. 移除映射依赖 - 全面采用SQLite直连
### 2. 删除废弃的映射相关功�?
### 3. 统一导航菜单组件
### 4. 简化Python工具依赖

---

## 📋 详细优化清单

### 一、移除Python映射脚本依赖

#### 当前状况
```
�?旧架�?(v0.1.0):
Python脚本 �?生成JSON映射 �?PHP读取映射 �?显示数据
      �?
generate_mapping_simple.py �?id_based_mapping.json �?BillfishManagerV2.php
```

#### 新架�?
```
�?新架�?(v0.1.1):
PHP直连SQLite �?实时查询 �?显示数据
      �?
BillfishManagerV3.php �?SQLite3扩展 �?billfish.db
```

#### 执行任务
- [x] �?已创�?`BillfishManagerV3.php` (直连SQLite)
- [ ] 删除 `tools/mapping/generate_mapping_simple.py`
- [ ] 删除 `database-exports/id_based_mapping.json`
- [ ] 删除 `database-exports/complete_material_info.json`
- [ ] 更新文档说明不再需要Python环境

---

### 二、清理映射相关废弃功�?

#### 废弃的API接口 (`api.php`)
```php
�?删除以下action:
- refresh_mapping     // 刷新映射
- validate_mapping    // 验证映射准确�?
- check_updates       // 检查数据库更新
```

#### 废弃的前端功�?

**index.php** - 移除:
```javascript
�?function checkUpdates()      // 检查数据库更新
�?function refreshMapping()    // 刷新映射
�?function validateMapping()   // 验证映射准确�?
```

**browse.php** - 移除:
```javascript
�?function refreshMapping()    // 刷新映射按钮
```

**status.php** - 整页重构:
```
�?旧功�? 映射状态监�?
�?新功�? 数据库健康检�?
```

#### 执行任务
- [ ] 清理 `api.php` 废弃接口
- [ ] 清理 `index.php` 映射相关JS函数
- [ ] 清理 `browse.php` 刷新映射按钮
- [ ] 重构 `status.php` �?`database-health.php`

---

### 三、统一导航菜单组件�?

#### 当前问题
```
index.php:      首页 | 浏览 | 搜索 | 标签 | 文档 | 工具 | 状�? (7�?
browse.php:     首页 | 浏览 | 搜索 | 标签 | 状�?            (5�? �?
status.php:     首页 | 浏览 | 搜索 | 状�?                  (4�? �?
docs-ui.php:    首页 | 浏览 | 搜索 | 文档 | 工具             (5�? �?
tools-ui.php:   首页 | 浏览 | 搜索 | 文档 | 工具             (5�? �?
```

#### 解决方案: 创建导航组件

**文件**: `includes/NavigationComponent.php`

```php
<?php
class NavigationComponent {
    private $currentPage;
    
    public function __construct($currentPage) {
        $this->currentPage = $currentPage;
    }
    
    public function render() {
        $menuItems = [
            'index.php' => ['icon' => 'home', 'text' => '首页'],
            'browse.php' => ['icon' => 'th', 'text' => '浏览'],
            'search.php' => ['icon' => 'search', 'text' => '搜索'],
            'tags.php' => ['icon' => 'tags', 'text' => '标签'],
            'docs-ui.php' => ['icon' => 'book', 'text' => '文档'],
            'tools-ui.php' => ['icon' => 'tools', 'text' => '工具'],
            'database-health.php' => ['icon' => 'heartbeat', 'text' => '健康检�?]
        ];
        
        // 输出统一导航HTML
    }
}
?>
```

#### 执行任务
- [ ] 创建 `includes/NavigationComponent.php`
- [ ] 更新所有PHP页面使用统一导航
- [ ] 测试所有页面导航一致�?

---

### 四、重构数据库健康检�?

#### 新功能设�?

**文件**: `database-health.php` (替代 `status.php`)

**检查项**:
1. �?**数据库连�?*: SQLite扩展状�?
2. �?**表完整�?*: 核心表是否存�?
3. �?**数据一致�?*: 文件记录 vs 预览图记�?
4. �?**文件可达�?*: 文件路径是否有效
5. �?**预览图生成率**: 有多少文件缺少预览图
6. �?**数据库大�?*: billfish.db文件大小监控
7. �?**最后同步时�?*: Billfish最后修改时�?

**组件**: `includes/DatabaseHealthChecker.php`

```php
class DatabaseHealthChecker {
    public function checkConnection()      // 检查SQLite连接
    public function checkTables()          // 检查表完整�?
    public function checkDataIntegrity()   // 检查数据一致�?
    public function checkFileAccess()      // 检查文件可达�?
    public function checkPreviewCoverage() // 检查预览图覆盖�?
    public function getDatabaseSize()      // 获取数据库大�?
    public function getLastSyncTime()      // 获取最后同步时�?
}
```

#### 执行任务
- [ ] 创建 `includes/DatabaseHealthChecker.php`
- [ ] 创建 `database-health.php` 页面
- [ ] 删除旧的 `status.php`
- [ ] 更新导航菜单链接

---

### 五、简化Python工具依赖

#### 保留的Python工具 (可选分析工�?
```
tools/analysis/
├── export_database.py    # �?保留 - 数据导出CSV
├── list_tables.py        # �?保留 - 表结构分�?
└── deep_analysis.py      # �?保留 - 深度数据分析
```

#### 删除的Python工具 (已被SQLite替代)
```
tools/mapping/
└── generate_mapping_simple.py  # �?删除 - 不再需要预生成映射
```

#### 更新文档
- [ ] 更新 `README.md` - 说明Python为可选依�?
- [ ] 更新 `quick-start.md` - 移除映射生成步骤
- [ ] 创建 `optional-tools.md` - Python分析工具使用指南

---

## 🗂�?文件变更清单

### 新增文件
```
includes/NavigationComponent.php        # 统一导航组件
includes/DatabaseHealthChecker.php      # 数据库健康检�?
includes/DatabaseSyncChecker.php        # 数据库同步检�?
database-health.php                     # 健康检查页�?
docs/user-guide/optional-tools.md       # 可选工具指�?
```

### 修改文件
```
index.php                   # 移除映射相关JS,使用导航组件
browse.php                  # 使用统一导航组件
search.php                  # 使用统一导航组件
tags.php                    # 使用统一导航组件
docs-ui.php                 # 使用统一导航组件
tools-ui.php                # 使用统一导航组件
api.php                     # 删除映射相关接口
config.php                  # 添加健康检查配�?
```

### 删除文件
```
status.php                                    # �?database-health.php 替代
tools/mapping/generate_mapping_simple.py      # 不再需要预生成映射
database-exports/id_based_mapping.json        # 不再使用JSON映射
database-exports/complete_material_info.json  # 不再使用JSON映射
includes/BillfishManagerV2.php               # �?V3 替代
```

---

## 📊 优化效果预期

### 性能提升
- �?**实时数据**: 不再依赖预生成映�?数据始终最�?
- �?**更快加载**: 直连SQLite比读JSON更快
- �?**减少维护**: 无需定期刷新映射

### 用户体验
- �?**统一导航**: 所有页面菜单一�?
- �?**实时监控**: 数据库健康状态实时显�?
- �?**简化部�?*: 无需Python环境即可运行

### 代码质量
- �?**组件�?*: 导航组件可复�?
- �?**职责清晰**: 健康检查独立模�?
- �?**易于维护**: 减少冗余代码

---

## 🔄 执行顺序

### 阶段1: 创建新组�?(不影响现有功�?
1. 创建 `NavigationComponent.php`
2. 创建 `DatabaseHealthChecker.php`
3. 创建 `database-health.php`
4. 测试新功�?

### 阶段2: 迁移现有页面
1. 更新 `index.php` 使用新导�?
2. 更新 `browse.php` 使用新导�?
3. 更新 `search.php` 使用新导�?
4. 更新其他页面
5. 测试所有页�?

### 阶段3: 清理废弃功能
1. 清理 `api.php` 映射接口
2. 清理 `index.php` 映射JS
3. 清理 `browse.php` 映射按钮
4. 删除 `status.php`
5. 删除映射Python脚本
6. 删除映射JSON文件

### 阶段4: 文档更新
1. 更新 `README.md`
2. 更新快速开始文�?
3. 创建可选工具文�?
4. 更新 `docs/config.json`

---

## �?验收标准

- [ ] 所有页面导航菜单完全一�?
- [ ] 数据库健康检查功能正�?
- [ ] 无映射相关错误和警告
- [ ] 删除所有映射相关代�?
- [ ] 文档完整更新
- [ ] 所有功能测试通过

---

## 📝 后续计划 (v0.1.2+)

- 添加数据库备份功�?
- 实现预览图批量生�?
- 支持Billfish标签同步
- 添加视频元数据编�?
- 实现多用户权限管�?

---

**制定日期**: 2025-10-15  
**计划版本**: v0.1.1  
**预计完成**: 2025-10-15

